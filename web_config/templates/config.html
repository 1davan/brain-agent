<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Agent - Configuration</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Brain Agent Configuration</h1>
            <div class="header-actions">
                <span class="status-badge status-{{ bot_status }}">
                    Bot: {{ bot_status.upper() }}
                </span>
                <a href="{{ url_for('logout') }}" class="btn btn-secondary btn-small">Logout</a>
            </div>
        </header>

        {% if message %}
        <div class="alert alert-success">{{ message }}</div>
        {% endif %}

        {% if error %}
        <div class="alert alert-error">{{ error }}</div>
        {% endif %}

        <form method="POST" id="configForm">
            <!-- Bot Controls -->
            <section class="card">
                <h2>Bot Controls</h2>
                <div class="button-group">
                    <button type="submit" name="action" value="start" class="btn btn-success"
                            {% if bot_status == 'running' %}disabled{% endif %}>
                        Start Bot
                    </button>
                    <button type="submit" name="action" value="stop" class="btn btn-danger"
                            {% if bot_status == 'stopped' %}disabled{% endif %}>
                        Stop Bot
                    </button>
                    <button type="submit" name="action" value="restart" class="btn btn-warning"
                            {% if bot_status == 'stopped' %}disabled{% endif %}>
                        Restart Bot
                    </button>
                </div>
            </section>

            <!-- Required Credentials -->
            <section class="card">
                <h2>Required Credentials</h2>
                <p class="section-desc">API keys and secrets. All other settings are configured in the Google Sheet Config tab.</p>

                <div class="form-group">
                    <label for="telegram_token">Telegram Bot Token</label>
                    <div class="input-with-button">
                        <input type="text" id="telegram_token" name="telegram_token"
                               value="{{ config.get('TELEGRAM_TOKEN', '') }}"
                               placeholder="8260664859:AAGpDn...">
                        <button type="button" class="btn btn-secondary btn-small" onclick="testTelegram()">Test</button>
                    </div>
                    <span class="test-result" id="telegram-result"></span>
                </div>

                <div class="form-group">
                    <label for="groq_api_key">Groq API Key</label>
                    <div class="input-with-button">
                        <input type="text" id="groq_api_key" name="groq_api_key"
                               value="{{ config.get('GROQ_API_KEY', '') }}"
                               placeholder="gsk_PNkOvM0x8Zo...">
                        <button type="button" class="btn btn-secondary btn-small" onclick="testGroq()">Test</button>
                    </div>
                    <span class="test-result" id="groq-result"></span>
                </div>

                <div class="form-group">
                    <label for="spreadsheet_id">Google Spreadsheet ID</label>
                    <input type="text" id="spreadsheet_id" name="spreadsheet_id"
                           value="{{ config.get('SPREADSHEET_ID', '') }}"
                           placeholder="14l7M7pcdiHffPTdggz4eiOVwJ5St6P3fHYyh5XZJALw">
                    <small>Found in the Google Sheets URL after /d/</small>
                </div>

                <div class="form-group">
                    <label for="credentials_json">Google Service Account JSON</label>
                    <div class="input-with-button" style="align-items: flex-start;">
                        <textarea id="credentials_json" name="credentials_json" rows="6"
                                  placeholder='Paste your service account JSON here...'>{{ creds_json }}</textarea>
                        <button type="button" class="btn btn-secondary btn-small" onclick="testSheets()">Test</button>
                    </div>
                    <span class="test-result" id="sheets-result"></span>
                    <small>Paste the entire contents of your service account JSON file</small>
                </div>
            </section>

            <!-- Optional Service Credentials -->
            <section class="card">
                <h2>Optional Service Credentials</h2>
                <p class="section-desc">Additional API credentials for extra features.</p>

                <div class="form-group">
                    <label for="calendar_id">Google Calendar ID</label>
                    <input type="text" id="calendar_id" name="calendar_id"
                           value="{{ config.get('GOOGLE_CALENDAR_ID', '') }}"
                           placeholder="primary or your.email@gmail.com">
                    <small>Use "primary" for your main calendar, or the calendar email address</small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="gmail_address">Gmail Address</label>
                        <input type="email" id="gmail_address" name="gmail_address"
                               value="{{ config.get('GMAIL_ADDRESS', '') }}"
                               placeholder="your.email@gmail.com">
                    </div>
                    <div class="form-group">
                        <label for="gmail_app_password">Gmail App Password</label>
                        <input type="password" id="gmail_app_password" name="gmail_app_password"
                               value="{{ config.get('GMAIL_APP_PASSWORD', '') }}"
                               placeholder="xxxx xxxx xxxx xxxx">
                        <small>Generate at myaccount.google.com/apppasswords</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="keep_token">Google Keep Token</label>
                    <input type="text" id="keep_token" name="keep_token"
                           value="{{ config.get('GOOGLE_KEEP_TOKEN', '') }}"
                           placeholder="Master token for Google Keep API">
                    <small>Optional - for Google Keep note integration</small>
                </div>
            </section>

            <!-- Web UI Security -->
            <section class="card">
                <h2>Web UI Security</h2>
                <div class="form-group">
                    <label for="web_password">Web UI Password</label>
                    <input type="password" id="web_password" name="web_password"
                           value="{{ config.get('WEB_PASSWORD', '') }}"
                           placeholder="Leave empty to keep current password">
                    <small>Password required to access this configuration page</small>
                </div>
            </section>

            <!-- Save Button -->
            <div class="form-actions">
                <button type="submit" name="action" value="save" class="btn btn-primary btn-large">
                    Save Credentials
                </button>
            </div>
        </form>

        <!-- Settings Info -->
        <section class="card">
            <h2>Bot Settings</h2>
            <p class="section-desc">
                All behavioral settings (check-in times, email styles, context limits, etc.) are configured in the
                <strong>Config</strong> tab of your Google Sheet. Changes there take effect on bot restart.
            </p>
            <p>
                <a href="https://docs.google.com/spreadsheets/d/{{ config.get('SPREADSHEET_ID', '') }}/edit#gid=0"
                   target="_blank" class="btn btn-secondary">
                    Open Google Sheet
                </a>
            </p>
        </section>

        <!-- Log Viewer -->
        <section class="card">
            <h2>Bot Logs</h2>
            <div class="log-controls">
                <button type="button" class="btn btn-secondary btn-small" onclick="refreshLogs()">Refresh Logs</button>
                <label>
                    <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()">
                    Auto-refresh
                </label>
            </div>
            <pre id="logViewer" class="log-viewer">Click "Refresh Logs" to view bot output...</pre>
        </section>
    </div>

    <script>
        let autoRefreshInterval = null;

        function testTelegram() {
            const token = document.getElementById('telegram_token').value;
            const result = document.getElementById('telegram-result');
            result.textContent = 'Testing...';
            result.className = 'test-result';

            fetch('/api/test/telegram', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({token: token})
            })
            .then(r => r.json())
            .then(data => {
                result.textContent = data.success ? data.message : data.error;
                result.className = 'test-result ' + (data.success ? 'success' : 'error');
            })
            .catch(e => {
                result.textContent = 'Test failed: ' + e;
                result.className = 'test-result error';
            });
        }

        function testGroq() {
            const apiKey = document.getElementById('groq_api_key').value;
            const result = document.getElementById('groq-result');
            result.textContent = 'Testing...';
            result.className = 'test-result';

            fetch('/api/test/groq', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({api_key: apiKey})
            })
            .then(r => r.json())
            .then(data => {
                result.textContent = data.success ? data.message : data.error;
                result.className = 'test-result ' + (data.success ? 'success' : 'error');
            })
            .catch(e => {
                result.textContent = 'Test failed: ' + e;
                result.className = 'test-result error';
            });
        }

        function testSheets() {
            const creds = document.getElementById('credentials_json').value;
            const sheetId = document.getElementById('spreadsheet_id').value;
            const result = document.getElementById('sheets-result');
            result.textContent = 'Testing...';
            result.className = 'test-result';

            fetch('/api/test/sheets', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({credentials: creds, spreadsheet_id: sheetId})
            })
            .then(r => r.json())
            .then(data => {
                result.textContent = data.success ? data.message : data.error;
                result.className = 'test-result ' + (data.success ? 'success' : 'error');
            })
            .catch(e => {
                result.textContent = 'Test failed: ' + e;
                result.className = 'test-result error';
            });
        }

        function refreshLogs() {
            fetch('/api/logs')
            .then(r => r.json())
            .then(data => {
                const viewer = document.getElementById('logViewer');
                if (data.logs && data.logs.length > 0) {
                    viewer.textContent = data.logs.join('\n');
                    viewer.scrollTop = viewer.scrollHeight;
                } else {
                    viewer.textContent = 'No logs available. Start the bot to see output.';
                }
            })
            .catch(e => {
                document.getElementById('logViewer').textContent = 'Error fetching logs: ' + e;
            });
        }

        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');
            if (checkbox.checked) {
                refreshLogs();
                autoRefreshInterval = setInterval(refreshLogs, 3000);
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }

        function updateStatus() {
            fetch('/api/status')
            .then(r => r.json())
            .then(data => {
                const badge = document.querySelector('.status-badge');
                badge.textContent = 'Bot: ' + data.status.toUpperCase();
                badge.className = 'status-badge status-' + data.status;
            });
        }

        // Update status every 5 seconds
        setInterval(updateStatus, 5000);
    </script>
</body>
</html>
